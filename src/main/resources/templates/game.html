<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>체스 게임 {{ id }}</title>
    <link rel="stylesheet" href="../css/game.css" />
  </head>
  <body>
    <div class="wrapper">
      <div class="chess-menu">
        <div class="chess-games"></div>
        <div class="chess-create">
          <div class="chess-create-submit">방 만들기</div>
        </div>
      </div>
      <div class="chess-board">
        <div class="chess-file">
          <div class="chess-symbol">A</div>
          <div class="chess-symbol">B</div>
          <div class="chess-symbol">C</div>
          <div class="chess-symbol">D</div>
          <div class="chess-symbol">E</div>
          <div class="chess-symbol">F</div>
          <div class="chess-symbol">G</div>
          <div class="chess-symbol">H</div>
        </div>
        <div class="chess-container">
          <div class="chess-rank">
            <div class="chess-symbol">1</div>
            <div class="chess-symbol">2</div>
            <div class="chess-symbol">3</div>
            <div class="chess-symbol">4</div>
            <div class="chess-symbol">5</div>
            <div class="chess-symbol">6</div>
            <div class="chess-symbol">7</div>
            <div class="chess-symbol">8</div>
          </div>
          <div class="chess-map">
            <div class="chess-row">
              <div class="chess-col" data-x="0" data-y="7"></div>
              <div class="chess-col" data-x="1" data-y="7"></div>
              <div class="chess-col" data-x="2" data-y="7"></div>
              <div class="chess-col" data-x="3" data-y="7"></div>
              <div class="chess-col" data-x="4" data-y="7"></div>
              <div class="chess-col" data-x="5" data-y="7"></div>
              <div class="chess-col" data-x="6" data-y="7"></div>
              <div class="chess-col" data-x="7" data-y="7"></div>
            </div>
            <div class="chess-row">
              <div class="chess-col" data-x="0" data-y="6"></div>
              <div class="chess-col" data-x="1" data-y="6"></div>
              <div class="chess-col" data-x="2" data-y="6"></div>
              <div class="chess-col" data-x="3" data-y="6"></div>
              <div class="chess-col" data-x="4" data-y="6"></div>
              <div class="chess-col" data-x="5" data-y="6"></div>
              <div class="chess-col" data-x="6" data-y="6"></div>
              <div class="chess-col" data-x="7" data-y="6"></div>
            </div>
            <div class="chess-row">
              <div class="chess-col" data-x="0" data-y="5"></div>
              <div class="chess-col" data-x="1" data-y="5"></div>
              <div class="chess-col" data-x="2" data-y="5"></div>
              <div class="chess-col" data-x="3" data-y="5"></div>
              <div class="chess-col" data-x="4" data-y="5"></div>
              <div class="chess-col" data-x="5" data-y="5"></div>
              <div class="chess-col" data-x="6" data-y="5"></div>
              <div class="chess-col" data-x="7" data-y="5"></div>
            </div>
            <div class="chess-row">
              <div class="chess-col" data-x="0" data-y="4"></div>
              <div class="chess-col" data-x="1" data-y="4"></div>
              <div class="chess-col" data-x="2" data-y="4"></div>
              <div class="chess-col" data-x="3" data-y="4"></div>
              <div class="chess-col" data-x="4" data-y="4"></div>
              <div class="chess-col" data-x="5" data-y="4"></div>
              <div class="chess-col" data-x="6" data-y="4"></div>
              <div class="chess-col" data-x="7" data-y="4"></div>
            </div>
            <div class="chess-row">
              <div class="chess-col" data-x="0" data-y="3"></div>
              <div class="chess-col" data-x="1" data-y="3"></div>
              <div class="chess-col" data-x="2" data-y="3"></div>
              <div class="chess-col" data-x="3" data-y="3"></div>
              <div class="chess-col" data-x="4" data-y="3"></div>
              <div class="chess-col" data-x="5" data-y="3"></div>
              <div class="chess-col" data-x="6" data-y="3"></div>
              <div class="chess-col" data-x="7" data-y="3"></div>
            </div>
            <div class="chess-row">
              <div class="chess-col" data-x="0" data-y="2"></div>
              <div class="chess-col" data-x="1" data-y="2"></div>
              <div class="chess-col" data-x="2" data-y="2"></div>
              <div class="chess-col" data-x="3" data-y="2"></div>
              <div class="chess-col" data-x="4" data-y="2"></div>
              <div class="chess-col" data-x="5" data-y="2"></div>
              <div class="chess-col" data-x="6" data-y="2"></div>
              <div class="chess-col" data-x="7" data-y="2"></div>
            </div>
            <div class="chess-row">
              <div class="chess-col" data-x="0" data-y="1"></div>
              <div class="chess-col" data-x="1" data-y="1"></div>
              <div class="chess-col" data-x="2" data-y="1"></div>
              <div class="chess-col" data-x="3" data-y="1"></div>
              <div class="chess-col" data-x="4" data-y="1"></div>
              <div class="chess-col" data-x="5" data-y="1"></div>
              <div class="chess-col" data-x="6" data-y="1"></div>
              <div class="chess-col" data-x="7" data-y="1"></div>
            </div>
            <div class="chess-row">
              <div class="chess-col" data-x="0" data-y="0"></div>
              <div class="chess-col" data-x="1" data-y="0"></div>
              <div class="chess-col" data-x="2" data-y="0"></div>
              <div class="chess-col" data-x="3" data-y="0"></div>
              <div class="chess-col" data-x="4" data-y="0"></div>
              <div class="chess-col" data-x="5" data-y="0"></div>
              <div class="chess-col" data-x="6" data-y="0"></div>
              <div class="chess-col" data-x="7" data-y="0"></div>
            </div>
          </div>
          <div class="chess-rank">
            <div class="chess-symbol">1</div>
            <div class="chess-symbol">2</div>
            <div class="chess-symbol">3</div>
            <div class="chess-symbol">4</div>
            <div class="chess-symbol">5</div>
            <div class="chess-symbol">6</div>
            <div class="chess-symbol">7</div>
            <div class="chess-symbol">8</div>
          </div>
        </div>
        <div class="chess-file">
          <div class="chess-symbol">A</div>
          <div class="chess-symbol">B</div>
          <div class="chess-symbol">C</div>
          <div class="chess-symbol">D</div>
          <div class="chess-symbol">E</div>
          <div class="chess-symbol">F</div>
          <div class="chess-symbol">G</div>
          <div class="chess-symbol">H</div>
        </div>
      </div>
      <div class="chess-status">
        <div class="chess-score-board">
          <div id="black-score" class="chess-score"></div>
          <div class="chess-piece pawn black"></div>
        </div>
        <div class="chess-score-board">
          <div id="white-score" class="chess-score"></div>
          <div class="chess-piece pawn white"></div>
        </div>
      </div>
      <div class="chess-alert hide">
        <div class="chess-alert-message"></div>
      </div>
      g
      <div class="chess-result hide">
        <div class="chess-result-message"></div>
        <div class="chess-result-restart">새로 시작</div>
      </div>
    </div>
    <script>
      const gameId = {{id}}
      const templateQueen = color => `<div class="chess-piece queen ${color}" draggable="true" ondrop="onDrop(event)" ondragstart="onDragStart(event)" ondragover="onDragOver(event)"></div>`
      const templateKing = color => `<div class="chess-piece king ${color}" draggable="true" ondrop="onDrop(event)" ondragstart="onDragStart(event)" ondragover="onDragOver(event)"></div>`
      const templateBishop = color => `<div class="chess-piece bishop ${color}" draggable="true" ondrop="onDrop(event)" ondragstart="onDragStart(event)" ondragover="onDragOver(event)"></div>`
      const templateKnight = color => `<div class="chess-piece knight ${color}" draggable="true" ondrop="onDrop(event)" ondragstart="onDragStart(event)" ondragover="onDragOver(event)"></div>`
      const templateRook = color => `<div class="chess-piece rook ${color}" draggable="true" ondrop="onDrop(event)" ondragstart="onDragStart(event)" ondragover="onDragOver(event)"></div>`
      const templatePawn = color => `<div class="chess-piece pawn ${color}" draggable="true" ondrop="onDrop(event)" ondragstart="onDragStart(event)" ondragover="onDragOver(event)"></div>`
      const templateBlank = `<div class="chess-piece blank" draggable="true" ondrop="onDrop(event)" ondragstart="onDragStart(event)" ondragover="onDragOver(event)"></div>`
      const templateGame = id => `<a href="/game/${id}" class="chess-game"><div class="chess-game-title">체스 게임 ${id}</div></a>`

      const blackScoreElement = document.querySelector('#black-score')
      const whiteScoreElement = document.querySelector('#white-score')
      const chessAlertElement = document.querySelector('.chess-alert')
      const chessAlertMessageElement = document.querySelector('.chess-alert-message')

      const chessResultElement = document.querySelector('.chess-result')
      const chessResultMessageElement = document.querySelector('.chess-result-message')
      const chessResultRestartElement = document.querySelector('.chess-result-restart')

      const chessGamesElement = document.querySelector('.chess-games')
      const chessCreateSubmitElement = document.querySelector('.chess-create-submit')

      const chessCellElements = document.querySelectorAll('.chess-col')
      const findChessCell = (x, y) => document.querySelector(`[data-x="${x}"][data-y="${y}"]`)

      chessCreateSubmitElement.onclick = () => {
          fetch('/create', {
              method: 'POST'
          })
          .then(response => response.json())
          .then(data => {
              if (data.statusCode == 1) {
                  location.replace('/game/' + data.dto)
              }
          })
      }

      chessResultRestartElement.onclick = () => {
          fetch('/restart/' + gameId, {
              method: 'POST'
          })
          .then(response => response.json())
          .then(data => {
              if (data.statusCode == 1) {
                  location.reload()
              }
          })
      }

      function showAlert(message, delay) {
          show(chessAlertElement)
          chessAlertMessageElement.innerHTML = message
          setTimeout(() => {
              hide(chessAlertElement)
          }, delay)
      }

      function show(element) {
          element.classList.remove('hide')
          element.classList.add('show')
      }

      function hide(element) {
          element.classList.remove('show')
          element.classList.add('hide')
      }

      const createTemplate = {
          p: templatePawn('white'),
          q: templateQueen('white'),
          k: templateKing('white'),
          r: templateRook('white'),
          b: templateBishop('white'),
          n: templateKnight('white'),
          P: templatePawn('black'),
          Q: templateQueen('black'),
          K: templateKing('black'),
          R: templateRook('black'),
          B: templateBishop('black'),
          N: templateKnight('black'),
      }

      fetch('http://localhost:4567/board/' + gameId)
      .then(response => response.json())
      .then(data => drawChessGame(data.dto))

      fetch('http://localhost:4567/games')
      .then(response => response.json())
      .then(data => drawGameList(data.dto))

      function drawGameList(games) {
          games.forEach(id => chessGamesElement.innerHTML += templateGame(id))
      }

      function drawChessGame({boardDto, turnDto, statusDto, isFinished}) {
          drawBoard(boardDto.board)
          drawStatus(statusDto)
          drawResult(statusDto, isFinished)
      }

      function drawResult(statusDto, isFinished) {
          if (!isFinished) {
              return
          }
          show(chessResultElement)
          chessResultMessageElement.innerHTML = statusDto.winner + ' 승'
      }

      function drawBoard(board) {
          chessCellElements.forEach((element, i) => {
              const symbol = board[i]
              element.innerHTML = symbol == '.' ? templateBlank : createTemplate[symbol]
          })
      }

      function drawStatus(statusDto) {
          blackScoreElement.innerHTML = statusDto.black.score
          whiteScoreElement.innerHTML = statusDto.white.score
      }

      function onDragStart(e) {
          e.dataTransfer.setData('x', e.target.parentElement.dataset.x)
          e.dataTransfer.setData('y', e.target.parentElement.dataset.y)
      }

      function onDragOver(e) {
          e.preventDefault()
      }

      function onDrop(e) {
          fetch('http://localhost:4567/move/' + gameId, {
              method: 'POST',
              body: JSON.stringify({
                  sx: parseInt(e.dataTransfer.getData('x')),
                  sy: parseInt(e.dataTransfer.getData('y')),
                  tx: parseInt(e.target.parentElement.dataset.x),
                  ty: parseInt(e.target.parentElement.dataset.y)
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.statusCode === 1) {
                  drawChessGame(data.dto)
                  return
              }
              showAlert(data.dto, 1000)
          })
      }
    </script>
  </body>
</html>
